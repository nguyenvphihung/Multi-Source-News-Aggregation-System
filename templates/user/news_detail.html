{% extends "user/baseUser.html" %}

{% block title %}{{ article.title if article else "BÃ i viáº¿t khÃ´ng tá»“n táº¡i" }}{% endblock %}

{% block content %}
<!-- Article Header -->
<div class="container">
    {% if article %}
    <div class="article-header">
        <div class="article-meta d-flex justify-content-between align-items-center text-muted small mb-2">
            <span class="text-uppercase">{{ article.type }}</span>
            <span>{{ article.date_posted.strftime('%d/%m/%Y %H:%M') }}</span>
        </div>
        <h1 class="article-title fw-bold mb-4">{{ article.title }}</h1>
        <div class="article-author d-flex align-items-center mb-4">
            <div class="author-avatar me-3"></div>
            <span>{{ article.author }}</span>
        </div>  
        <div class="article-stats d-flex gap-3 text-muted">
            <div class="d-flex align-items-center gap-1">
                <i class="fas fa-heart"></i>
                <span>{{ article.likes }}</span>
            </div>
            <div class="d-flex align-items-center gap-1">
                <i class="fas fa-comment"></i>
                <span>{{ article.comments_count }}</span>
            </div>
            <div class="d-flex align-items-center gap-1">
                <i class="fas fa-share"></i>
                <span>{{ article.shares }}</span>
            </div>
        </div>
    </div>

    <!-- Article Content -->
    <div class="article-content">
        <strong>{{ article.description }}</strong>  <!-- TÃ´ Ä‘áº­m -->
        {{ article.content|safe }}
    </div>
    
    <!-- Comment Section -->
    <div class="row ms-5 mt-5">
        <h3 class="mb-4">BÃ¬nh luáº­n ({{ article.comments_count|default(0) }})</h3>
        
        <!-- Comment Form -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="commentForm" method="post" action="/api/comments">
                    <input type="hidden" name="article_id" value="{{ article.article_id }}">
                    <div class="mb-3 position-relative">
                        <textarea class="form-control" name="content" id="commentTextarea" rows="3" placeholder="Viáº¿t bÃ¬nh luáº­n cá»§a báº¡n..." required></textarea>
                        <div class="position-absolute bottom-0 end-0 p-2 d-flex gap-2">
                            <button type="button" class="btn btn-sm text-muted border-0 emoji-picker-btn" title="ThÃªm biá»ƒu tÆ°á»£ng cáº£m xÃºc">
                                <i class="far fa-smile"></i>
                            </button>
                            <div class="emoji-picker" style="display: none;">
                                <div class="emoji-card">
                                    <div class="emoji-grid">
                                        <span class="emoji" data-emoji="ğŸ™‚">ğŸ™‚</span>
                                        <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                                        <span class="emoji" data-emoji="ğŸ˜‚">ğŸ˜‚</span>
                                        <span class="emoji" data-emoji="ğŸ¤£">ğŸ¤£</span>
                                        <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                                        <span class="emoji" data-emoji="ğŸ˜Š">ğŸ˜Š</span>
                                        
                                        <span class="emoji" data-emoji="ğŸ˜‹">ğŸ˜‹</span>
                                        <span class="emoji" data-emoji="ğŸ˜£">ğŸ˜£</span>
                                        <span class="emoji" data-emoji="ğŸ˜‰">ğŸ˜‰</span>
                                        <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                                        <span class="emoji" data-emoji="ğŸ˜ƒ">ğŸ˜ƒ</span>
                                        <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                                        
                                        <span class="emoji" data-emoji="ğŸ˜¡">ğŸ˜¡</span>
                                        <span class="emoji" data-emoji="ğŸ˜’">ğŸ˜’</span>
                                        <span class="emoji" data-emoji="ğŸ˜ˆ">ğŸ˜ˆ</span>
                                        <span class="emoji" data-emoji="ğŸ™„">ğŸ™„</span>
                                        <span class="emoji" data-emoji="ğŸ˜Œ">ğŸ˜Œ</span>
                                        <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                                        
                                        <span class="emoji" data-emoji="ğŸ˜„">ğŸ˜„</span>
                                        <span class="emoji" data-emoji="ğŸ˜‡">ğŸ˜‡</span>
                                        <span class="emoji" data-emoji="ğŸ˜†">ğŸ˜†</span>
                                        <span class="emoji" data-emoji="ğŸ™">ğŸ™</span>
                                        <span class="emoji" data-emoji="ğŸ˜‘">ğŸ˜‘</span>
                                        <span class="emoji" data-emoji="ğŸ˜•">ğŸ˜•</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifyReplies" name="notify_replies">
                            <label class="form-check-label" for="notifyReplies">
                                <i class="fas fa-bell me-1 text-muted"></i> ThÃ´ng bÃ¡o khi cÃ³ pháº£n há»“i
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-1"></i> Gá»­i bÃ¬nh luáº­n
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Comments List -->
        <div class="comments-list">
            {% if comments %}
                {% for comment in comments %}
                <div class="comment-item card mb-3">
                    <div class="card-body">
                        <div class="d-flex mb-2">
                            <div class="comment-avatar me-3">
                                {% if comment.user_avatar %}
                                <img src="{{ comment.user_avatar }}" alt="{{ comment.user_name }}" class="rounded-circle" width="40" height="40">
                                {% else %}
                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    {{ comment.user_name[:1].upper() }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="comment-info">
                                <h5 class="mb-0">{{ comment.user_name }}</h5>
                                <small class="text-muted">{{ comment.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                            </div>
                        </div>
                        <p class="comment-content">{{ comment.content }}</p>
                        <div class="comment-actions d-flex gap-3">
                            <button class="btn btn-sm btn-link p-0 reply-btn" data-comment-id="{{ comment.id }}">Pháº£n há»“i</button>
                            <button class="btn btn-sm btn-link p-0 like-btn" data-comment-id="{{ comment.id }}">
                                <i class="fas fa-thumbs-up me-1"></i> {{ comment.likes|default(0) }}
                            </button>
                        </div>
                        
                        <!-- Reply Form (hidden by default) -->
                        <div class="reply-form mt-3" id="replyForm-{{ comment.id }}" style="display: none;">
                            <form method="post" action="/api/comments/reply">
                                <input type="hidden" name="article_id" value="{{ article.article_id }}">
                                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                <div class="mb-2 position-relative">
                                    <textarea class="form-control reply-textarea" name="content" rows="2" placeholder="Viáº¿t pháº£n há»“i cá»§a báº¡n..." required></textarea>
                                    <div class="position-absolute bottom-0 end-0 p-2 d-flex gap-2">
                                        <button type="button" class="btn btn-sm text-muted border-0 emoji-picker-btn" title="ThÃªm biá»ƒu tÆ°á»£ng cáº£m xÃºc">
                                            <i class="far fa-smile"></i>
                                        </button>
                                        <div class="emoji-picker" style="display: none;">
                                            <div class="emoji-card">
                                                <div class="emoji-grid">
                                                    <span class="emoji" data-emoji="ğŸ™‚">ğŸ™‚</span>
                                                    <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                                                    <span class="emoji" data-emoji="ğŸ˜‚">ğŸ˜‚</span>
                                                    <span class="emoji" data-emoji="ğŸ¤£">ğŸ¤£</span>
                                                    <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                                                    <span class="emoji" data-emoji="ğŸ˜Š">ğŸ˜Š</span>
                                                    
                                                    <span class="emoji" data-emoji="ğŸ˜‹">ğŸ˜‹</span>
                                                    <span class="emoji" data-emoji="ğŸ˜£">ğŸ˜£</span>
                                                    <span class="emoji" data-emoji="ğŸ˜‰">ğŸ˜‰</span>
                                                    <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                                                    <span class="emoji" data-emoji="ğŸ˜ƒ">ğŸ˜ƒ</span>
                                                    <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                                                    
                                                    <span class="emoji" data-emoji="ğŸ˜¡">ğŸ˜¡</span>
                                                    <span class="emoji" data-emoji="ğŸ˜’">ğŸ˜’</span>
                                                    <span class="emoji" data-emoji="ğŸ˜ˆ">ğŸ˜ˆ</span>
                                                    <span class="emoji" data-emoji="ğŸ™„">ğŸ™„</span>
                                                    <span class="emoji" data-emoji="ğŸ˜Œ">ğŸ˜Œ</span>
                                                    <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                                                    
                                                    <span class="emoji" data-emoji="ğŸ˜„">ğŸ˜„</span>
                                                    <span class="emoji" data-emoji="ğŸ˜‡">ğŸ˜‡</span>
                                                    <span class="emoji" data-emoji="ğŸ˜†">ğŸ˜†</span>
                                                    <span class="emoji" data-emoji="ğŸ™">ğŸ™</span>
                                                    <span class="emoji" data-emoji="ğŸ˜‘">ğŸ˜‘</span>
                                                    <span class="emoji" data-emoji="ğŸ˜•">ğŸ˜•</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="fas fa-paper-plane me-1"></i> Gá»­i pháº£n há»“i
                                </button>
                            </form>
                        </div>
                        
                        <!-- Replies -->
                        {% if comment.replies %}
                        <div class="replies-list mt-3 ms-4">
                            {% for reply in comment.replies %}
                            <div class="reply-item mb-3">
                                <div class="d-flex mb-2">
                                    <div class="reply-avatar me-2">
                                        {% if reply.user_avatar %}
                                        <img src="{{ reply.user_avatar }}" alt="{{ reply.user_name }}" class="rounded-circle" width="30" height="30">
                                        {% else %}
                                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">
                                            {{ reply.user_name[:1].upper() }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="reply-info">
                                        <h6 class="mb-0">{{ reply.user_name }}</h6>
                                        <small class="text-muted">{{ reply.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                        <p class="reply-content mb-1">{{ reply.content }}</p>
                                        <button class="btn btn-sm btn-link p-0 like-btn" data-comment-id="{{ reply.id }}">
                                            <i class="fas fa-thumbs-up me-1"></i> {{ reply.likes|default(0) }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                
                <!-- Pagination -->
                {% if total_pages > 1 %}
                <nav aria-label="Comment pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {{ 'disabled' if current_page == 1 else '' }}">
                            <a class="page-link" href="?comment_page={{ current_page - 1 }}" tabindex="-1" {{ 'aria-disabled="true"' if current_page == 1 else '' }}>TrÆ°á»›c</a>
                        </li>
                        {% for page in range(1, total_pages + 1) %}
                        <li class="page-item {{ 'active' if page == current_page else '' }}">
                            <a class="page-link" href="?comment_page={{ page }}">{{ page }}</a>
                        </li>
                        {% endfor %}
                        <li class="page-item {{ 'disabled' if current_page == total_pages else '' }}">
                            <a class="page-link" href="?comment_page={{ current_page + 1 }}">Tiáº¿p</a>
                        </li>
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <div class="alert alert-light text-center">
                    <p>ChÆ°a cÃ³ bÃ¬nh luáº­n nÃ o. HÃ£y lÃ  ngÆ°á»i Ä‘áº§u tiÃªn bÃ¬nh luáº­n!</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <p class="text-danger">BÃ i viáº¿t khÃ´ng tá»“n táº¡i hoáº·c Ä‘Ã£ bá»‹ xÃ³a.</p>
    {% endif %}
</div>

<!-- JavaScript cho pháº§n bÃ¬nh luáº­n -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Xá»­ lÃ½ hiá»ƒn thá»‹ form pháº£n há»“i
        const replyButtons = document.querySelectorAll('.reply-btn');
        replyButtons.forEach(button => {
            button.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                const replyForm = document.getElementById(`replyForm-${commentId}`);
                replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
            });
        });
        
        // Xá»­ lÃ½ nÃºt thÃ­ch
        const likeButtons = document.querySelectorAll('.like-btn');
        likeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                // Gá»­i yÃªu cáº§u AJAX Ä‘á»ƒ tÄƒng sá»‘ lÆ°á»£t thÃ­ch
                fetch(`/api/comments/${commentId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Cáº­p nháº­t sá»‘ lÆ°á»£t thÃ­ch trÃªn giao diá»‡n
                        const likeCount = this.querySelector('i').nextSibling;
                        likeCount.textContent = ` ${data.likes}`;
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
        
        // Xá»­ lÃ½ gá»­i bÃ¬nh luáº­n
        const commentForm = document.getElementById('commentForm');
        if (commentForm) {
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                
                fetch('/api/comments', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // LÃ m má»›i trang Ä‘á»ƒ hiá»ƒn thá»‹ bÃ¬nh luáº­n má»›i
                        window.location.reload();
                    } else {
                        alert('CÃ³ lá»—i xáº£y ra khi gá»­i bÃ¬nh luáº­n. Vui lÃ²ng thá»­ láº¡i.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('CÃ³ lá»—i xáº£y ra khi gá»­i bÃ¬nh luáº­n. Vui lÃ²ng thá»­ láº¡i.');
                });
            });
        }
        
        // Xá»­ lÃ½ emoji picker
        const emojiPickerBtns = document.querySelectorAll('.emoji-picker-btn');
        
        // ÄÃ³ng táº¥t cáº£ emoji picker khi click ra ngoÃ i
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.emoji-picker-btn') && !e.target.closest('.emoji-picker')) {
                document.querySelectorAll('.emoji-picker').forEach(picker => {
                    picker.style.display = 'none';
                });
            }
        });
        
        // Hiá»ƒn thá»‹/áº©n emoji picker khi click vÃ o nÃºt
        emojiPickerBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                // ÄÃ³ng táº¥t cáº£ emoji picker khÃ¡c
                document.querySelectorAll('.emoji-picker').forEach(picker => {
                    if (picker !== this.nextElementSibling) {
                        picker.style.display = 'none';
                    }
                });
                
                // Hiá»ƒn thá»‹/áº©n emoji picker hiá»‡n táº¡i
                const emojiPicker = this.nextElementSibling;
                emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
            });
        });
        
        // Xá»­ lÃ½ khi chá»n emoji
        document.querySelectorAll('.emoji').forEach(emoji => {
            emoji.addEventListener('click', function() {
                // TÃ¬m textarea gáº§n nháº¥t
                const emojiPicker = this.closest('.emoji-picker');
                const emojiBtn = emojiPicker.previousElementSibling;
                const textareaContainer = emojiBtn.closest('.position-relative');
                const textarea = textareaContainer.querySelector('textarea');
                
                // ChÃ¨n emoji vÃ o vá»‹ trÃ­ con trá»
                const emojiChar = this.getAttribute('data-emoji');
                const startPos = textarea.selectionStart;
                const endPos = textarea.selectionEnd;
                const text = textarea.value;
                
                textarea.value = text.substring(0, startPos) + emojiChar + text.substring(endPos);
                
                // Äáº·t vá»‹ trÃ­ con trá» sau emoji
                textarea.selectionStart = textarea.selectionEnd = startPos + emojiChar.length;
                
                // Focus vÃ o textarea
                textarea.focus();
                
                // ÄÃ³ng emoji picker
                emojiPicker.style.display = 'none';
            });
        });
    });
</script>
{% endblock %}

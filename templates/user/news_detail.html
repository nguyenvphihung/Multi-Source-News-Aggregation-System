{% extends "user/baseUser.html" %}

{% block title %}{{ article.title if article else "B√†i vi·∫øt kh√¥ng t·ªìn t·∫°i" }}{% endblock %}

{% block content %}
<style>
/* PhoBERT Notification Styles */
.phobert-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    max-width: 400px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-left: 4px solid;
    z-index: 9999;
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.phobert-notification.show {
    transform: translateX(0);
}

.notification-success { border-left-color: #28a745; }
.notification-error { border-left-color: #dc3545; }
.notification-info { border-left-color: #17a2b8; }

.notification-content {
    display: flex;
    align-items: flex-start;
    padding: 16px;
    gap: 12px;
}

.notification-icon {
    font-size: 20px;
    margin-top: 2px;
}

.notification-success .notification-icon { color: #28a745; }
.notification-error .notification-icon { color: #dc3545; }
.notification-info .notification-icon { color: #17a2b8; }

.notification-text {
    flex: 1;
}

.notification-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
    color: #333;
}

.notification-message {
    font-size: 12px;
    color: #666;
    line-height: 1.4;
    white-space: pre-line;
}

.notification-close {
    background: none;
    border: none;
    font-size: 18px;
    color: #999;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.notification-close:hover {
    color: #666;
}

/* Status Indicator */
.moderation-status {
    margin-bottom: 10px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

/* Loading Button Animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.fa-spin {
    animation: spin 1s linear infinite;
}

/* Comment Warning */
.comment-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    margin-top: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.comment-warning i {
    color: #f39c12;
}
</style>
<!-- Article Header -->
<div class="container">
    {% if article %}
    <div class="article-header">
        <div class="article-meta d-flex justify-content-between align-items-center text-muted small mb-2">
            <span class="text-uppercase">{{ article.type }}</span>
            <span>{{ article.date_posted.strftime('%d/%m/%Y %H:%M') }}</span>
        </div>
        <h1 class="article-title fw-bold mb-4">{{ article.title }}</h1>
        <div class="article-author d-flex align-items-center mb-4">
            <div class="author-avatar me-3"></div>
            <span>{{ article.author }}</span>
        </div>  
        <div class="article-stats d-flex gap-3 text-muted">
            <div class="d-flex align-items-center gap-1">
                <i class="fas fa-heart"></i>
                <span>{{ article.likes }}</span>
            </div>
            <div class="d-flex align-items-center gap-1">
                <i class="fas fa-comment"></i>
                <span>{{ article.comments_count }}</span>
            </div>
            <div class="d-flex align-items-center gap-1">
                <i class="fas fa-share"></i>
                <span>{{ article.shares }}</span>
            </div>
        </div>
    </div>

    <!-- Article Content -->
    <div class="article-content">
        <strong>{{ article.description }}</strong>  <!-- T√¥ ƒë·∫≠m -->
        {{ article.content|safe }}
    </div>
    
    <!-- Comment Section -->
    <div class="row ms-5 mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0">B√¨nh lu·∫≠n ({{ article.comments_count|default(0) }})</h3>
            <div id="moderation-status" class="moderation-status">
                <i class="fas fa-circle-notch fa-spin"></i> ƒêang ki·ªÉm tra h·ªá th·ªëng...
            </div>
        </div>
        
        <!-- Comment Form -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="commentForm" method="post" action="/api/comments">
                    <input type="hidden" name="article_id" value="{{ article.article_id }}">
                    <div class="mb-3 position-relative">
                        <textarea class="form-control" name="content" id="commentTextarea" rows="3" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." required></textarea>
                        <!-- TEMPORARY: Hidden warning for PhoBERT testing -->
                        <div id="comment-preview-warning" class="comment-warning" style="display: none !important;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>N·ªôi dung n√†y c√≥ th·ªÉ b·ªã t·ª´ ch·ªëi. Vui l√≤ng ki·ªÉm tra l·∫°i!</span>
                        </div>
                        <div class="position-absolute bottom-0 end-0 p-2 d-flex gap-2">
                            <button type="button" class="btn btn-sm text-muted border-0 emoji-picker-btn" title="Th√™m bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c">
                                <i class="far fa-smile"></i>
                            </button>
                            <div class="emoji-picker" style="display: none;">
                                <div class="emoji-card">
                                    <div class="emoji-grid">
                                        <span class="emoji" data-emoji="üôÇ">üôÇ</span>
                                        <span class="emoji" data-emoji="üòÅ">üòÅ</span>
                                        <span class="emoji" data-emoji="üòÇ">üòÇ</span>
                                        <span class="emoji" data-emoji="ü§£">ü§£</span>
                                        <span class="emoji" data-emoji="üòê">üòê</span>
                                        <span class="emoji" data-emoji="üòä">üòä</span>
                                        
                                        <span class="emoji" data-emoji="üòã">üòã</span>
                                        <span class="emoji" data-emoji="üò£">üò£</span>
                                        <span class="emoji" data-emoji="üòâ">üòâ</span>
                                        <span class="emoji" data-emoji="üòç">üòç</span>
                                        <span class="emoji" data-emoji="üòÉ">üòÉ</span>
                                        <span class="emoji" data-emoji="üòé">üòé</span>
                                        
                                        <span class="emoji" data-emoji="üò°">üò°</span>
                                        <span class="emoji" data-emoji="üòí">üòí</span>
                                        <span class="emoji" data-emoji="üòà">üòà</span>
                                        <span class="emoji" data-emoji="üôÑ">üôÑ</span>
                                        <span class="emoji" data-emoji="üòå">üòå</span>
                                        <span class="emoji" data-emoji="üòè">üòè</span>
                                        
                                        <span class="emoji" data-emoji="üòÑ">üòÑ</span>
                                        <span class="emoji" data-emoji="üòá">üòá</span>
                                        <span class="emoji" data-emoji="üòÜ">üòÜ</span>
                                        <span class="emoji" data-emoji="üôÅ">üôÅ</span>
                                        <span class="emoji" data-emoji="üòë">üòë</span>
                                        <span class="emoji" data-emoji="üòï">üòï</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifyReplies" name="notify_replies">
                            <label class="form-check-label" for="notifyReplies">
                                <i class="fas fa-bell me-1 text-muted"></i> Th√¥ng b√°o khi c√≥ ph·∫£n h·ªìi
                            </label>
                        </div>
                        <div id="phobert-stats" class="small text-muted" style="display: none;">
                            <i class="fas fa-chart-line"></i> <span id="stats-content"></span>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-1"></i> G·ª≠i b√¨nh lu·∫≠n
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Comments List -->
        <div class="comments-list">
            {% if comments %}
                {% for comment in comments %}
                <div class="comment-item card mb-3">
                    <div class="card-body">
                        <div class="d-flex mb-2">
                            <div class="comment-avatar me-3">
                                {% if comment.user_avatar %}
                                <img src="{{ comment.user_avatar }}" alt="{{ comment.user_name }}" class="rounded-circle" width="40" height="40">
                                {% else %}
                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    {{ comment.user_name[:1].upper() }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="comment-info">
                                <h5 class="mb-0">{{ comment.user_name }}</h5>
                                <small class="text-muted">{{ comment.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                            </div>
                        </div>
                        <p class="comment-content">{{ comment.content }}</p>
                        <div class="comment-actions d-flex gap-3">
                            <button class="btn btn-sm btn-link p-0 reply-btn" data-comment-id="{{ comment.id }}">Ph·∫£n h·ªìi</button>
                            <button class="btn btn-sm btn-link p-0 like-btn" data-comment-id="{{ comment.id }}">
                                <i class="fas fa-thumbs-up me-1"></i> {{ comment.likes|default(0) }}
                            </button>
                        </div>
                        
                        <!-- Reply Form (hidden by default) -->
                        <div class="reply-form mt-3" id="replyForm-{{ comment.id }}" style="display: none;">
                            <form method="post" action="/api/comments/reply">
                                <input type="hidden" name="article_id" value="{{ article.article_id }}">
                                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                <div class="mb-2 position-relative">
                                    <textarea class="form-control reply-textarea" name="content" rows="2" placeholder="Vi·∫øt ph·∫£n h·ªìi c·ªßa b·∫°n..." required></textarea>
                                    <div class="position-absolute bottom-0 end-0 p-2 d-flex gap-2">
                                        <button type="button" class="btn btn-sm text-muted border-0 emoji-picker-btn" title="Th√™m bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c">
                                            <i class="far fa-smile"></i>
                                        </button>
                                        <div class="emoji-picker" style="display: none;">
                                            <div class="emoji-card">
                                                <div class="emoji-grid">
                                                    <span class="emoji" data-emoji="üôÇ">üôÇ</span>
                                                    <span class="emoji" data-emoji="üòÅ">üòÅ</span>
                                                    <span class="emoji" data-emoji="üòÇ">üòÇ</span>
                                                    <span class="emoji" data-emoji="ü§£">ü§£</span>
                                                    <span class="emoji" data-emoji="üòê">üòê</span>
                                                    <span class="emoji" data-emoji="üòä">üòä</span>
                                                    
                                                    <span class="emoji" data-emoji="üòã">üòã</span>
                                                    <span class="emoji" data-emoji="üò£">üò£</span>
                                                    <span class="emoji" data-emoji="üòâ">üòâ</span>
                                                    <span class="emoji" data-emoji="üòç">üòç</span>
                                                    <span class="emoji" data-emoji="üòÉ">üòÉ</span>
                                                    <span class="emoji" data-emoji="üòé">üòé</span>
                                                    
                                                    <span class="emoji" data-emoji="üò°">üò°</span>
                                                    <span class="emoji" data-emoji="üòí">üòí</span>
                                                    <span class="emoji" data-emoji="üòà">üòà</span>
                                                    <span class="emoji" data-emoji="üôÑ">üôÑ</span>
                                                    <span class="emoji" data-emoji="üòå">üòå</span>
                                                    <span class="emoji" data-emoji="üòè">üòè</span>
                                                    
                                                    <span class="emoji" data-emoji="üòÑ">üòÑ</span>
                                                    <span class="emoji" data-emoji="üòá">üòá</span>
                                                    <span class="emoji" data-emoji="üòÜ">üòÜ</span>
                                                    <span class="emoji" data-emoji="üôÅ">üôÅ</span>
                                                    <span class="emoji" data-emoji="üòë">üòë</span>
                                                    <span class="emoji" data-emoji="üòï">üòï</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="fas fa-paper-plane me-1"></i> G·ª≠i ph·∫£n h·ªìi
                                </button>
                            </form>
                        </div>
                        
                        <!-- Replies -->
                        {% if comment.replies %}
                        <div class="replies-list mt-3 ms-4">
                            {% for reply in comment.replies %}
                            <div class="reply-item mb-3">
                                <div class="d-flex mb-2">
                                    <div class="reply-avatar me-2">
                                        {% if reply.user_avatar %}
                                        <img src="{{ reply.user_avatar }}" alt="{{ reply.user_name }}" class="rounded-circle" width="30" height="30">
                                        {% else %}
                                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">
                                            {{ reply.user_name[:1].upper() }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="reply-info">
                                        <h6 class="mb-0">{{ reply.user_name }}</h6>
                                        <small class="text-muted">{{ reply.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                        <p class="reply-content mb-1">{{ reply.content }}</p>
                                        <button class="btn btn-sm btn-link p-0 like-btn" data-comment-id="{{ reply.id }}">
                                            <i class="fas fa-thumbs-up me-1"></i> {{ reply.likes|default(0) }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                
                <!-- Pagination -->
                {% if total_pages > 1 %}
                <nav aria-label="Comment pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {{ 'disabled' if current_page == 1 else '' }}">
                            <a class="page-link" href="?comment_page={{ current_page - 1 }}" tabindex="-1" {{ 'aria-disabled="true"' if current_page == 1 else '' }}>Tr∆∞·ªõc</a>
                        </li>
                        {% for page in range(1, total_pages + 1) %}
                        <li class="page-item {{ 'active' if page == current_page else '' }}">
                            <a class="page-link" href="?comment_page={{ page }}">{{ page }}</a>
                        </li>
                        {% endfor %}
                        <li class="page-item {{ 'disabled' if current_page == total_pages else '' }}">
                            <a class="page-link" href="?comment_page={{ current_page + 1 }}">Ti·∫øp</a>
                        </li>
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <div class="alert alert-light text-center">
                    <p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n b√¨nh lu·∫≠n!</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <p class="text-danger">B√†i vi·∫øt kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a.</p>
    {% endif %}
</div>

<!-- JavaScript cho ph·∫ßn b√¨nh lu·∫≠n -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // X·ª≠ l√Ω hi·ªÉn th·ªã form ph·∫£n h·ªìi
        const replyButtons = document.querySelectorAll('.reply-btn');
        replyButtons.forEach(button => {
            button.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                const replyForm = document.getElementById(`replyForm-${commentId}`);
                replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
            });
        });
        
        // X·ª≠ l√Ω n√∫t th√≠ch
        const likeButtons = document.querySelectorAll('.like-btn');
        likeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                // G·ª≠i y√™u c·∫ßu AJAX ƒë·ªÉ tƒÉng s·ªë l∆∞·ª£t th√≠ch
                fetch(`/api/comments/${commentId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£t th√≠ch tr√™n giao di·ªán
                        const likeCount = this.querySelector('i').nextSibling;
                        likeCount.textContent = ` ${data.likes}`;
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
        
        // X·ª≠ l√Ω g·ª≠i b√¨nh lu·∫≠n v·ªõi PhoBERT integration
        const commentForm = document.getElementById('commentForm');
        if (commentForm) {
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const submitBtn = this.querySelector('button[type="submit"]');
                const commentTextarea = document.getElementById('commentTextarea');
                
                // Hi·ªÉn th·ªã loading state
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> ƒêang x·ª≠ l√Ω...';
                
                fetch('/api/comments', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i> G·ª≠i b√¨nh lu·∫≠n';
                    
                    console.log('üîÑ PhoBERT Response:', data);
                    
                    if (data.success) {
                        if (data.status === 'approved') {
                            // Label 0/1 ‚Üí PhoBERT APPROVED ‚Üí L∆∞u DB + Hi·ªÉn th·ªã ngay
                            showSuccessMessage(data.message || 'üéâ B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát!');
                            commentTextarea.value = '';
                            
                            // Log PhoBERT info
                            if (data.phobert_info) {
                                console.log('ü§ñ PhoBERT Approved:', data.phobert_info);
                            }
                            
                            // Reload ƒë·ªÉ hi·ªÉn th·ªã comment m·ªõi
                            setTimeout(() => window.location.reload(), 1500);
                            
                        } else if (data.status === 'pending_moderation') {
                            // Colab workflow fallback
                            showInfoMessage('‚è≥ ' + (data.message || 'B√¨nh lu·∫≠n ƒëang ch·ªù ki·ªÉm duy·ªát'));
                            commentTextarea.value = '';
                            
                        } else {
                            // Tr∆∞·ªùng h·ª£p kh√°c
                            showSuccessMessage(data.message || '‚úÖ B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i');
                            commentTextarea.value = '';
                        }
                    } else {
                        // Comment b·ªã t·ª´ ch·ªëi ho·∫∑c c√≥ l·ªói
                        if (data.status === 'rejected') {
                            // Label 2 ‚Üí PhoBERT REJECTED ‚Üí Th√¥ng b√°o ƒë·ªè, kh√¥ng l∆∞u DB
                            showErrorMessage(data.message || 'üö´ B√¨nh lu·∫≠n b·ªã t·ª´ ch·ªëi');
                            
                            // Log PhoBERT info
                            if (data.phobert_info) {
                                console.log('ü§ñ PhoBERT Rejected:', data.phobert_info);
                            }
                            
                            // KH√îNG clear form ƒë·ªÉ user c√≥ th·ªÉ edit
                            
                        } else if (data.status === 'db_error') {
                            showErrorMessage('üóÑÔ∏è ' + (data.message || 'L·ªói database'));
                            
                        } else {
                            showErrorMessage('‚ùå ' + (data.message || 'C√≥ l·ªói x·∫£y ra khi g·ª≠i b√¨nh lu·∫≠n'));
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i> G·ª≠i b√¨nh lu·∫≠n';
                    showErrorMessage('‚ùå L·ªói k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ g·ª≠i b√¨nh lu·∫≠n. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i.');
                });
            });
        }
        
        // X·ª≠ l√Ω g·ª≠i ph·∫£n h·ªìi v·ªõi PhoBERT integration
        document.querySelectorAll('form[action="/api/comments/reply"]').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const submitBtn = this.querySelector('button[type="submit"]');
                const replyTextarea = this.querySelector('.reply-textarea');
                
                // Hi·ªÉn th·ªã loading state
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> ƒêang x·ª≠ l√Ω...';
                
                fetch('/api/comments/reply', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i> G·ª≠i ph·∫£n h·ªìi';
                    
                    console.log('üîÑ PhoBERT Reply Response:', data);
                    
                    if (data.success) {
                        if (data.status === 'approved') {
                            // Label 0/1 ‚Üí PhoBERT APPROVED ‚Üí L∆∞u DB + Hi·ªÉn th·ªã ngay
                            showSuccessMessage(data.message || 'üéâ Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát!');
                            replyTextarea.value = '';
                            this.closest('.reply-form').style.display = 'none';
                            
                            // Log PhoBERT info
                            if (data.phobert_info) {
                                console.log('ü§ñ PhoBERT Reply Approved:', data.phobert_info);
                            }
                            
                            // Reload ƒë·ªÉ hi·ªÉn th·ªã reply m·ªõi
                            setTimeout(() => window.location.reload(), 1500);
                            
                        } else if (data.status === 'pending_moderation') {
                            // Colab workflow fallback
                            showInfoMessage('‚è≥ ' + (data.message || 'Ph·∫£n h·ªìi ƒëang ch·ªù ki·ªÉm duy·ªát'));
                            replyTextarea.value = '';
                            this.closest('.reply-form').style.display = 'none';
                            
                        } else {
                            // Tr∆∞·ªùng h·ª£p kh√°c
                            showSuccessMessage(data.message || '‚úÖ Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c g·ª≠i');
                            replyTextarea.value = '';
                            this.closest('.reply-form').style.display = 'none';
                        }
                    } else {
                        // Reply b·ªã t·ª´ ch·ªëi ho·∫∑c c√≥ l·ªói
                        if (data.status === 'rejected') {
                            // Label 2 ‚Üí PhoBERT REJECTED ‚Üí Th√¥ng b√°o ƒë·ªè, kh√¥ng l∆∞u DB
                            showErrorMessage(data.message || 'üö´ Ph·∫£n h·ªìi b·ªã t·ª´ ch·ªëi');
                            
                            // Log PhoBERT info
                            if (data.phobert_info) {
                                console.log('ü§ñ PhoBERT Reply Rejected:', data.phobert_info);
                            }
                            
                            // KH√îNG clear form v√† ·∫©n ƒë·ªÉ user c√≥ th·ªÉ edit
                            
                        } else if (data.status === 'db_error') {
                            showErrorMessage('üóÑÔ∏è ' + (data.message || 'L·ªói database'));
                            
                        } else {
                            showErrorMessage('‚ùå ' + (data.message || 'C√≥ l·ªói x·∫£y ra khi g·ª≠i ph·∫£n h·ªìi'));
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i> G·ª≠i ph·∫£n h·ªìi';
                    showErrorMessage('‚ùå L·ªói k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ g·ª≠i ph·∫£n h·ªìi. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i.');
                });
            });
        });
        
        // === UTILITY FUNCTIONS FOR NOTIFICATIONS ===
        
        function createNotification(type, title, message) {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.phobert-notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `phobert-notification notification-${type}`;
            
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
            
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${icon} notification-icon"></i>
                    <div class="notification-text">
                        <div class="notification-title">${title}</div>
                        ${message ? `<div class="notification-message">${message}</div>` : ''}
                    </div>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Show with animation
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }
        
        function showSuccessMessage(title, message = '') {
            createNotification('success', title, message);
        }
        
        function showErrorMessage(title, message = '') {
            createNotification('error', title, message);
        }
        
        function showInfoMessage(title, message = '') {
            createNotification('info', title, message);
        }
        
        // Hi·ªÉn th·ªã tr·∫°ng th√°i moderation khi trang load
        fetch('/api/moderation-status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const moderationInfo = data.data;
                    const statusIndicator = document.getElementById('moderation-status');
                    if (statusIndicator) {
                        const isLocalModel = moderationInfo.use_local_model;
                        const isModelLoaded = moderationInfo.phobert_model_loaded;
                        
                        if (isLocalModel && isModelLoaded) {
                            statusIndicator.innerHTML = '<i class="fas fa-robot text-success"></i> AI PhoBERT ƒëang ho·∫°t ƒë·ªông';
                            statusIndicator.className = 'small text-success';
                            
                            // Hi·ªÉn th·ªã stats n·∫øu c√≥
                            const phobertStats = document.getElementById('phobert-stats');
                            const statsContent = document.getElementById('stats-content');
                            if (phobertStats && statsContent) {
                                const device = moderationInfo.phobert_device || 'CPU';
                                statsContent.textContent = `Model: PhoBERT | Device: ${device} | Labels: 3 classes`;
                                phobertStats.style.display = 'block';
                            }
                        } else {
                            statusIndicator.innerHTML = '<i class="fas fa-cloud text-warning"></i> Ch·∫ø ƒë·ªô Colab';
                            statusIndicator.className = 'small text-warning';
                        }
                    }
                }
            })
            .catch(error => console.log('Could not fetch moderation status'));
        
        // === REAL-TIME COMMENT PREVIEW ===
        
        const toxicKeywords = [
            'dm', 'ƒëm', 'fuck', 'shit', 'ngu', 'kh·ªën', 's√∫c v·∫≠t', 'th·∫±ng lol', 'con ch√≥', 'm·∫π ki·∫øp',
            'spam', 'click here', 'win money', 'free money', 'virus', 'hack'
        ];
        
        function checkCommentContent(text) {
            if (!text || text.length < 3) return false;
            
            const lowerText = text.toLowerCase().trim();
            const found = toxicKeywords.some(keyword => lowerText.includes(keyword.toLowerCase()));
            
            // Debug log ƒë·ªÉ ki·ªÉm tra
            if (found) {
                console.log('üö® Toxic content detected:', text);
                console.log('üîç Matched keywords:', toxicKeywords.filter(k => lowerText.includes(k.toLowerCase())));
            } else {
                console.log('‚úÖ Clean content:', text);
            }
            
            return found;
        }
        
        // Real-time check cho comment ch√≠nh
        const commentTextarea = document.getElementById('commentTextarea');
        const commentWarning = document.getElementById('comment-preview-warning');
        
        if (commentTextarea && commentWarning) {
            let checkTimeout;
            commentTextarea.addEventListener('input', function() {
                clearTimeout(checkTimeout);
                                 checkTimeout = setTimeout(() => {
                     const content = this.value.trim();
                     // TEMPORARY: Disable warning for testing PhoBERT
                     commentWarning.style.display = 'none';
                     
                     // Uncomment below to re-enable warning
                     // if (checkCommentContent(content)) {
                     //     commentWarning.style.display = 'flex';
                     // } else {
                     //     commentWarning.style.display = 'none';
                     // }
                 }, 500); // Debounce 500ms
            });
        }
        
        // Real-time check cho reply textareas
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('reply-textarea')) {
                let warningElement = e.target.parentElement.querySelector('.reply-warning');
                
                // T·∫°o warning element n·∫øu ch∆∞a c√≥
                if (!warningElement) {
                    warningElement = document.createElement('div');
                    warningElement.className = 'comment-warning reply-warning';
                    warningElement.style.display = 'none';
                    warningElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>N·ªôi dung n√†y c√≥ th·ªÉ b·ªã t·ª´ ch·ªëi. Vui l√≤ng ki·ªÉm tra l·∫°i!</span>';
                    e.target.parentElement.appendChild(warningElement);
                }
                
                                 const content = e.target.value.trim();
                 // TEMPORARY: Disable warning for testing PhoBERT
                 warningElement.style.display = 'none';
                 
                 // Uncomment below to re-enable warning
                 // if (checkCommentContent(content)) {
                 //     warningElement.style.display = 'flex';
                 // } else {
                 //     warningElement.style.display = 'none';
                 // }
            }
        });
        
        // X·ª≠ l√Ω emoji picker
        const emojiPickerBtns = document.querySelectorAll('.emoji-picker-btn');
        
        // ƒê√≥ng t·∫•t c·∫£ emoji picker khi click ra ngo√†i
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.emoji-picker-btn') && !e.target.closest('.emoji-picker')) {
                document.querySelectorAll('.emoji-picker').forEach(picker => {
                    picker.style.display = 'none';
                });
            }
        });
        
        // Hi·ªÉn th·ªã/·∫©n emoji picker khi click v√†o n√∫t
        emojiPickerBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                // ƒê√≥ng t·∫•t c·∫£ emoji picker kh√°c
                document.querySelectorAll('.emoji-picker').forEach(picker => {
                    if (picker !== this.nextElementSibling) {
                        picker.style.display = 'none';
                    }
                });
                
                // Hi·ªÉn th·ªã/·∫©n emoji picker hi·ªán t·∫°i
                const emojiPicker = this.nextElementSibling;
                emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
            });
        });
        
        // X·ª≠ l√Ω khi ch·ªçn emoji
        document.querySelectorAll('.emoji').forEach(emoji => {
            emoji.addEventListener('click', function() {
                // T√¨m textarea g·∫ßn nh·∫•t
                const emojiPicker = this.closest('.emoji-picker');
                const emojiBtn = emojiPicker.previousElementSibling;
                const textareaContainer = emojiBtn.closest('.position-relative');
                const textarea = textareaContainer.querySelector('textarea');
                
                // Ch√®n emoji v√†o v·ªã tr√≠ con tr·ªè
                const emojiChar = this.getAttribute('data-emoji');
                const startPos = textarea.selectionStart;
                const endPos = textarea.selectionEnd;
                const text = textarea.value;
                
                textarea.value = text.substring(0, startPos) + emojiChar + text.substring(endPos);
                
                // ƒê·∫∑t v·ªã tr√≠ con tr·ªè sau emoji
                textarea.selectionStart = textarea.selectionEnd = startPos + emojiChar.length;
                
                // Focus v√†o textarea
                textarea.focus();
                
                // ƒê√≥ng emoji picker
                emojiPicker.style.display = 'none';
            });
        });
    });
</script>
{% endblock %}
